<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/leaf-favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/leaf-favicon-16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="码码更健康">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="码码更健康">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="乡村程序员">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>码码更健康</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">码码更健康</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">对代码永远保持敬畏</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/27/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="乡村程序员">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码码更健康">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/27/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" class="post-title-link" itemprop="url">分布式系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-27 23:17:00" itemprop="dateCreated datePublished" datetime="2021-05-27T23:17:00+08:00">2021-05-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-31 08:18:25" itemprop="dateModified" datetime="2021-05-31T08:18:25+08:00">2021-05-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">分布式系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="分布式系统"><a href="#分布式系统" class="headerlink" title="分布式系统"></a>分布式系统</h1><h2 id="GFS（Google-File-System）"><a href="#GFS（Google-File-System）" class="headerlink" title="GFS（Google File System）"></a>GFS（Google File System）</h2><h3 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h3><p>GFS的节点可以分为三种：GFS Master（主控服务器）、GFS ChunkServer（CS，数据块服务器）以及GFS客户端。</p>
<p>客户端是GFS提供给应用程序的访问接口，客户端访问GFS的时候，首先访问主控服务器节点，获取与之进行交互的CS信息，然后直接访问这些CS，完成数据交互工作。</p>
<h3 id="Master设计"><a href="#Master设计" class="headerlink" title="Master设计"></a>Master设计</h3><p>Master维护了系统中的元数据，包括文件及chunk命名空间、文件到chunk之间的映射、chunk副本的位置信息。</p>
<p>负载均衡：</p>
<p>为了提高系统的可用性，GFS会避免将同一个chunk的所有副本都存放在同一个机架的情况。</p>
<p>三种创建chunk副本的情况：chunk创建、chunk复制以及负载均衡。</p>
<h2 id="BigTable"><a href="#BigTable" class="headerlink" title="BigTable"></a>BigTable</h2><p>BigTable系统保证强一致性，同一时刻同一个子表只能被一台Tablet Server服务。这通过Chubby的互斥锁机制保证。当Tablet Server启动时候需要获取Chubby互斥锁，当Tablet Server出现故障，Master需要等到互斥锁失效，才能把它上面的子表迁移到其他Tablet Server。</p>
<p>BitTable的底层存储系统使用GFS。GFS本质是一个弱一致模型，只保证“同一个记录至少成功写入一次”，但可能存在一些补零记录、重复记录。</p>
<p>BigTable写入GFS的数据分为两种：</p>
<ul>
<li>操作日志：当Tablet Server发生故障时，它上卖弄服务的子表会被集群中的其他Tablet Server加载继续提供服务。加载子表可能需要回放操作日志，每条操作日志都有唯一序号，通过它可以去除重复的操作日志。</li>
<li>每个子表的SSTable数据：如果GFS写入失败，可以重试并产生多条重复记录，但是BigTable只会索引最后一条写入成功的记录。</li>
</ul>
<p><strong>BigTable本质上是构建 在GFS之上的一层分布式索引，通过它解决了GFS遗留的一致性问题</strong></p>
<p>为了提高性能，Tablet Server没有为它服务的每个子表单独存储日志，而是讲它服务的所有子表看的操作日志混在一起写入GFS，每条日志通过&lt;表格编号，行主键，日志序列号&gt;来唯一标识。</p>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>子表是负载均衡的基本单位。</p>
<p>Tablet Server定期向Master汇报状态，当状态检测时发现某个Tablet Server上的负载过重的时候，Master会自动对其进行负载均衡，即执行子表迁移工作。</p>
<ul>
<li>第一步请求原有的Tablet Server卸载子表；</li>
<li>第二部选择一台负载较低的Tablet Server加载子表。</li>
</ul>
<p>为了尽量减少停服务的时间，BigTable内部的策略是Minor Compaction。</p>
<ul>
<li>对原有的子表执行一遍Minor Compaction操作，操作过程中仍然允许写操作。</li>
<li>停止子表服务，对子表再执行一边Minor Compaction操作，由于第一次Minor Compaction过程中写的数据一般比较少，所以第二次写入的数据一般比较少。</li>
</ul>
<h3 id="分裂和合并"><a href="#分裂和合并" class="headerlink" title="分裂和合并"></a>分裂和合并</h3><p>BigTable中如果写入过多，可能出现某些子表过大，某些子表过小的情况，需要执行分裂和合并操作。</p>
<p>每个子表的数据分为内存中的MemTable和GFS中的多个SSTable，由于同一个子表只被一台Tablet Server服务，进行分裂比较简单，不需要进行实际的数据拷贝工作，只要将内存中的索引分成两个范围即可。</p>
<p>合并操作由Master发起，相比分类操作会更加复杂，由于两个子表可能被不同的Tablet Server加载，合并的第一步需要迁移其中一个子表，以使它们在同一个Tablet Server上，接着通知Tablet Server执行子表合并。</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>BigTable把可扩展性做到了极致，但是也面临了一些问题：</p>
<ul>
<li>BigTable非常适合离线或者半线上业务，然而Tablet Server节点出现故障时，部分数据短时间内无法提供读写服务，不适合实时性要求特别高的业务，比如交易类业务。</li>
<li>架构的复杂性导致问题特别难定位：BigTable依赖GFS和Chubby，而这两者本身就非常复杂，这将导致使用的过程中很难发现问题。</li>
</ul>
<h2 id="Megastore"><a href="#Megastore" class="headerlink" title="Megastore"></a>Megastore</h2><p>Megastore 融合了 NoSQL 的扩展性(scalability)和 RDBMS 的便利性(convenience)， 提供强一致性保证(strong consistency guarantees) 和高可用性(high availability)。 在数据的细粒度分区(fine-grained partitions)中提供了完全可序列化的 ACID 语义。 在广域网同步复制(synchronously replicate)每一次写操作，具有合理的延迟(reasonable latency)， 支持在数据中心间无缝故障转移(seamless failover)。</p>
<p>Megastore由三个部分组成：</p>
<ul>
<li>客户端库，应用程序通过客户端操作Megastore的实体组。Megastore系统大部分功能集中在客户端，包括映射Megastore操作到BigTable，事务即并发控制，基于Paxos的复制。</li>
<li>复制服务器：接受客户端的用户请求并转发到所在机房的BigTable实例（解决跨机房连接数太多的问题）。</li>
<li>协调者：存储每个机房本地的实体组是否最新状态的信息，用于实现快速读。</li>
</ul>
<p>Megastore功能主要三个部分：映射Megastore数据模型到BigTable，事务及并发控制，跨机房数据复制及读写优化。</p>
<p>Megastore首先解析用户通过客户端传入的SQL请求，接着根据用户定义的Megastore数据模型讲SQL请求转化为对底层BigTable的操作。</p>
<h3 id="实体组"><a href="#实体组" class="headerlink" title="实体组"></a>实体组</h3><p>每个实体组内的操作日志采用Paxos的方式同步到多个机房，保证强一致性。实体组之间通过分布式队列的方式保证最终一致性或者两阶段提交协议的方式实现分布式事务。</p>
<ul>
<li><p>单集群实体组内部：同一个实体内部支持满足ACID特性的事务。通过REDO日志的方式来实现。</p>
</li>
<li><p>单集群实体组之间：实体组之间一般采用分布式队列的方式提供最终一致性，子表服务器上有定时扫描线程，发送跨实体组的操作到目的实体组。如果需要保证多个实体组之间的强一致性，即分布式事务，只能通过两阶段提交协议加锁协调。</p>
</li>
</ul>
<h3 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h3><p>三种读方式：</p>
<ul>
<li>最新读取</li>
<li>快照读取</li>
<li>非一致性读取</li>
</ul>
<p>前两种方式都是在单个实体组内部完成的，在读取之前确保所有已提交的写操作已经全部生效，然后读取最后一个版本的数据。对于快照读取，系统已知的最后一个完整数据十五版本并取出该版本的数据。这两种读取方式利用率BigTable存储多版本数据的特性，保证不会读到未提交的事务。非一致性读取忽略日志的状态而直接读取BigTable内存中最新的值。</p>
<p>写事务：</p>
<p>先将所有的操作都在日志中记录下来后，写操作才会对数据库执行修改。</p>
<p>大致流程：</p>
<ul>
<li>读取：获取最后一次提交事务的时间戳和日志位置。</li>
<li>应用逻辑：从BigTable读取并且讲写操作聚集到日志缓冲区中；</li>
<li>提交：将缓冲区中的操作日志追加到多个机房的BigTable集群，通过Paxos的协议保证一致性；</li>
<li>生效：应用操作日志，更新BigTable中的实体和索引；</li>
<li>清理：删除不需要的数据。</li>
</ul>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><p>Megastore数据模型中有一个非常重要的概念：索引，分为两大类：</p>
<ul>
<li>局部索引：只在单个实体组内部的，用于加速单个实体组内部的查找。局部索引属于某个实体组，实体组内部数据和局部索引的更新操作是原子里的。</li>
<li>全局索引：全局索引横跨多个实体组。</li>
</ul>
<h3 id="协调者"><a href="#协调者" class="headerlink" title="协调者"></a>协调者</h3><h4 id="快速读"><a href="#快速读" class="headerlink" title="快速读"></a>快速读</h4><p>Paxos协议要求读取最新的数据至少需要经过一半以上的副本，然而，如果不出现故障，每个副本基本都是最新的。也就是说，能够利用本地读取实现快速读，减少读取延时和跨机操作。Megastore引入协调者来记录每个本机房Bigtable实例中的每个实体组的数据是否最新。如果最新，读取操作只需要本地读取，没有跨机房操作。实体组有更新操作时，写操作需要将协调者记录的实体组状态更新为无效。如果某个机房的Bigtable集群写入失败，需要首先使得相应的协调者记录实体组状态失效以后写操作才可以成功返回客户端。</p>
<h4 id="协调者的可用性"><a href="#协调者的可用性" class="headerlink" title="协调者的可用性"></a>协调者的可用性</h4><p>每次写操作都要涉及协调者，因此协调者出现故障将会导致系统不可用。当协调者因为网络或者主机故障等原因不可用时，需要检测到协调者故障并将它隔离。</p>
<p>Megastore使用了Chubby锁服务，协调者在启动时从数据中心获取Chubby锁。为了处理请求，协调者必须持有Chubby锁。一旦因为出现问题导致锁失效，协调者会恢复到一个默认的保守状态：认为所有它所能看见的实体组都是失效的。然后，从协调者不可用到锁失效有一个短暂的Chubby锁过期时间，这个时间段写操作都会失败。所有的写入者都必须等待协调者的Chubby锁过期。</p>
<h3 id="竞争条件"><a href="#竞争条件" class="headerlink" title="竞争条件"></a>竞争条件</h3><p>除了可用性问题，对于协调者的读写协议必须满足一系列的竞争条件。失效操作总是安全的，但是生效操作必须谨慎处理。在异步网络环境中，消息可能乱序达到协调者。每条生效和失效消息都带有日志位置信息。如果协调者先收到较晚的是小操作再收到较早的生效操作，生效操作将被忽略。</p>
<h3 id="读取流程"><a href="#读取流程" class="headerlink" title="读取流程"></a>读取流程</h3><p>Megastore的读取流程如图所示，Megastore最新读取流程如下：</p>
<p><img src="../images/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/QQ%E5%9B%BE%E7%89%8720210530231200.jpg" alt="QQ图片20210530231200"></p>
<h3 id="写入流程"><a href="#写入流程" class="headerlink" title="写入流程"></a>写入流程</h3><p><img src="../images/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20210530232408623.png" alt="image-20210530232408623"></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>Megastore的创新点：</p>
<ul>
<li>提出实体组的数据模型，通过实体组内部维持关系型数据库的ACID特性。实体组之间维持类似NoSQL的弱一致性，有效地融合了SQL和NoSQL两者的优势。</li>
<li>通过Paxos协议保证高可靠性和高可用性，即把数据强同步到多个机房，又做到发生故障时，自动切换不影响读写服务。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/22/C-%E7%BC%96%E8%AF%91%E9%93%BE%E6%8E%A5%E6%A8%A1%E5%9E%8B%E7%B2%BE%E8%A6%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="乡村程序员">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码码更健康">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/22/C-%E7%BC%96%E8%AF%91%E9%93%BE%E6%8E%A5%E6%A8%A1%E5%9E%8B%E7%B2%BE%E8%A6%81/" class="post-title-link" itemprop="url">C++编译链接模型精要</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-05-22 21:38:00 / 修改时间：21:38:11" itemprop="dateCreated datePublished" datetime="2021-05-22T21:38:00+08:00">2021-05-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/22/C++%E7%BC%96%E8%AF%91%E9%93%BE%E6%8E%A5%E6%A8%A1%E5%9E%8B%E7%B2%BE%E8%A6%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="乡村程序员">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码码更健康">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/22/C++%E7%BC%96%E8%AF%91%E9%93%BE%E6%8E%A5%E6%A8%A1%E5%9E%8B%E7%B2%BE%E8%A6%81/" class="post-title-link" itemprop="url">C++编译链接模型精要</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-22 21:38:00" itemprop="dateCreated datePublished" datetime="2021-05-22T21:38:00+08:00">2021-05-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-25 09:14:13" itemprop="dateModified" datetime="2021-05-25T09:14:13+08:00">2021-05-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo(int);\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">foo</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">char</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo(char);\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">bar</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>C++的函数重载决议，当C++编译器读到一个函数调用语句时，它必须从目前已看到的同名函数中选出最佳函数。哪怕后面的代码中出现了最合适的匹配。这意味着如果我们交换两个namespace级的函数定义在源代码中的位置，那么有可能改变程序的行为。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/13/%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="乡村程序员">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码码更健康">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/13/%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">索引与算法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-13 23:03:00" itemprop="dateCreated datePublished" datetime="2021-05-13T23:03:00+08:00">2021-05-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-22 21:36:34" itemprop="dateModified" datetime="2021-05-22T21:36:34+08:00">2021-05-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">MySQL学习</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL%E5%AD%A6%E4%B9%A0/InnoDB/" itemprop="url" rel="index"><span itemprop="name">InnoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="索引与算法"><a href="#索引与算法" class="headerlink" title="索引与算法"></a>索引与算法</h1><h2 id="InnoDB存储引擎概述"><a href="#InnoDB存储引擎概述" class="headerlink" title="InnoDB存储引擎概述"></a>InnoDB存储引擎概述</h2><p>InnoDB存储引擎支持以下几种常见索引：</p>
<ul>
<li>B+树索引</li>
<li>全文索引</li>
<li>哈希索引</li>
</ul>
<h3 id="聚集索引"><a href="#聚集索引" class="headerlink" title="聚集索引"></a>聚集索引</h3><p>聚集索引就是按照每张表的主键构造一棵B+树，同时叶子节点中存放的即为整张表的行记录数据，也将聚集索引的叶子节点称为数据页。聚集索引的这个特性决定了索引组织表中数据也是索引的一部分。同时B+树数据结构一样，每个数据页都通过双向链表来进行链接。</p>
<p>每张表只能拥有一个聚集索引哦！</p>
<p>数据页上存放的是完整的每行的记录，而在非数据页的索引页中，存放的仅仅是键值及指向数据页的偏移量，而不是一个完整的行记录。</p>
<p>聚集索引的存储并不是物理上连续的，而是逻辑上连续的。这其中有两点：一是前面说过的页通过双向链表链接，页按照主键的顺序排序；另一点是每个页中的记录也是通过双向链表进行维护的，物理存储上可以同样不按照主键存储。</p>
<p>聚集索引的一个好处就是：对于主键的排序查找和范围查找速度非常快。叶子节点的数据就是用户要查询的数据。</p>
<h3 id="辅助索引"><a href="#辅助索引" class="headerlink" title="辅助索引"></a>辅助索引</h3><p>对于辅助索引，叶子节点并不包含行记录的全部数据。叶子节点除了包含键值以外，每个叶子节点中的索引行中还包含了一个书签。该书签用来告诉InnoDB存储引擎哪里可以找到与索引相对应的行数据。由于InnoDb存储引擎表是索引组织表，因此InnoDB存储引擎中辅助索引与聚集索引的关系。</p>
<p>辅助索引的存在并不影响数据在聚集索引中的组织，因此每张表上可以有多个辅助索引。当通过辅助索引来寻找数据时，InnoDB存储引擎会遍历辅助索引并通过叶级别的指针获得指向主键索引的主键。然后再通过主键索引来找到一个完整的行记录。</p>
<p>聚集索引和非聚集索引的优缺点：</p>
<ul>
<li>聚集索引：检索效率高，索引占用的空间少，对数据新增/修改/删除的速度影响比较大。</li>
<li>非聚集索引：不影响表中的数据存储顺序，检索效率比聚集索引低，索引占用硬盘存储空间大，对数据新增/修改/删除的影响很少。</li>
</ul>
<p>MySQL数据库对于索引的添加或者删除的这类DDL操作，MySQL数据库的操作过程为：</p>
<ul>
<li>首先创建一张新的临时表，表结构为通过命令ALTER TABLE新定义的结构。</li>
<li>然后把原表中数据导入到临时表。</li>
<li>接着删除原表。</li>
<li>最后把临时表重名为原来的表名。</li>
</ul>
<p>这个操作会导致数据库服务暂时不可用（要修改的表）。</p>
<p>InnoDB存储引擎后面开始支持一种称为Fast Index Creation的索引创建方式——简称FIC。</p>
<p>对于辅助索引的建立，InnoDB存储引擎会对创建索引的表上加上一个S锁。在创建的过程中，不需要重建表，因此速度较之前提高了很多，并且数据结构的可用性也得到了提高。删除辅助索引操作就更简单了，InnoDB存储引擎只需要更新内部视图，并将辅助索引的空间标记为可用，同时删除MySQL数据库内部视图上对该表的索引定义即可。</p>
<p>由于FIC在索引的创建过程中加上了S锁，因此在创建过程中只能对该表进行读操作，若有大量的事务需要对目标表进行写操作，那么数据库的服务同样不可用。</p>
<p><strong>Online Schema Change</strong></p>
<p>OSC（在线架构改变）最早是FaceBook实现的一种在线执行DDL的方式，并广泛地应用于Facebook的MySQL数据库。所谓”在线“是指在事务的创建过程中，可以有读写事务对表进行操作，这提高了原有的MySQL数据库在DDL操作时的并发性。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/11/%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="乡村程序员">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码码更健康">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/11/%E8%A1%A8/" class="post-title-link" itemprop="url">表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-11 11:12:00" itemprop="dateCreated datePublished" datetime="2021-05-11T11:12:00+08:00">2021-05-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-22 21:36:34" itemprop="dateModified" datetime="2021-05-22T21:36:34+08:00">2021-05-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">MySQL学习</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL%E5%AD%A6%E4%B9%A0/InnoDB/" itemprop="url" rel="index"><span itemprop="name">InnoDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="表"><a href="#表" class="headerlink" title="表"></a>表</h1><h2 id="InnoDB逻辑存储结构"><a href="#InnoDB逻辑存储结构" class="headerlink" title="InnoDB逻辑存储结构"></a>InnoDB逻辑存储结构</h2><p>从InnoDB存储引擎的逻辑存储结构看，所有数据都被逻辑地存放在一个空间中，称之为表空间。</p>
<p>表空间（tablespace）又由段（segment）、区（extent）、页（page）组成。页在一些文档中有时也称为块。</p>
<h3 id="表空间"><a href="#表空间" class="headerlink" title="表空间"></a>表空间</h3><p>在默认情况下InnoDB存储引擎有一个共享表空间ibddata1，即所有的数据都存放在这个表空间内。如果启用了innodb_file_per_table。则每张表内的数据可以单独放在一个表空间内。</p>
<p>如果启用了innodb_file_per_table的参数，需要注意的是每张表的表空间内存放的只是数据、索引和插入缓冲Bitmap页。其他类型的数据，比如回滚信息，插入缓冲索引页，系统事务信息，二次写缓冲等还是存放在原来的共享表空间内。</p>
<h3 id="段"><a href="#段" class="headerlink" title="段"></a>段</h3><p>表空间是由各种段组成的，常见的段有数据段、索引段、回滚段等。数据段和索引段其实就是B+树的叶子节点和非叶子节点。</p>
<h3 id="区"><a href="#区" class="headerlink" title="区"></a>区</h3><p>区是由连续的页组成的空间，在任何情况下每个区的大小都为1MB。在默认情况下一个区中有64个连续的页。</p>
<h2 id="InnoDB数据页结构"><a href="#InnoDB数据页结构" class="headerlink" title="InnoDB数据页结构"></a>InnoDB数据页结构</h2><p>InnoDB数据页由以下7个部分组成：</p>
<ul>
<li>File Header（文件头）</li>
<li>Page Header（页头）</li>
<li>Infimun和Supremum Records</li>
<li>User Records（用户记录，即行记录）</li>
<li>Free Space（空闲空间）</li>
<li>Page Directory（页目录）</li>
<li>File Trailer（文件结尾信息）</li>
</ul>
<h3 id="File-Header"><a href="#File-Header" class="headerlink" title="File Header"></a>File Header</h3><p>File Header用来记录页的一些头信息，由8个部分组成，共占用38字节。</p>
<h3 id="Page-Header"><a href="#Page-Header" class="headerlink" title="Page Header"></a>Page Header</h3><p>该部分用于记录数据页的状态信息，由14个部分组成，共占用56字节。</p>
<h3 id="Infimum和Supremum-Record"><a href="#Infimum和Supremum-Record" class="headerlink" title="Infimum和Supremum Record"></a>Infimum和Supremum Record</h3><p>InnoDB引擎中，每个数据页都有两个虚拟的行记录用来限定记录的边界，Infimum记录是比该页中任何主键值都要小的值，Supremum指比任何可能大的值还要大的值。这两个值在页创建时被建立，并且在任何情况下不会被删除。</p>
<h3 id="User-Record和Free-Space"><a href="#User-Record和Free-Space" class="headerlink" title="User Record和Free Space"></a>User Record和Free Space</h3><p>User Record就是实际存储行记录的内容。</p>
<p>强调：InnoDb存储引擎表从事B+索引组织的。</p>
<p>Free Space很明显指的是空闲空间，同样也是个链表数据结构。在一条记录被删除后，该空间会被加入到空闲链表中。</p>
<h3 id="Page-Directory"><a href="#Page-Directory" class="headerlink" title="Page Directory"></a>Page Directory</h3><p>Page Directory中存放了记录的相对位置，有些时候这些记录指针称为Slots或目录槽。与其他数据库不同的是，在InnoDB中并不是每个记录拥有一个槽，InnoDB存储引擎的槽是一个稀疏目录，即也给槽中可能包含多个记录。</p>
<h3 id="File-Trailer"><a href="#File-Trailer" class="headerlink" title="File Trailer"></a>File Trailer</h3><p>为了检测页是否完整的写入磁盘，InnoDB存储引擎的页中设置了File Trailer部分。</p>
<p>File Trailer只有Fil_PAGE_END_LSN部分，占用8个字节，前4个字节代表了该页的checksum值，最后4个字节和File Header中的FIL_PAGE_LSN相同。将这两个值和File Header中的两个值进行对比，，看是否一致。</p>
<h2 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h2><h3 id="数据完整性"><a href="#数据完整性" class="headerlink" title="数据完整性"></a>数据完整性</h3><p>InnoDB存储引擎提供了以下几种约束：</p>
<ul>
<li>Primary Key</li>
<li>Unique Key</li>
<li>Foreign Key</li>
<li>Default</li>
<li>NOT NULL</li>
</ul>
<h3 id="约束的创建和查找"><a href="#约束的创建和查找" class="headerlink" title="约束的创建和查找"></a>约束的创建和查找</h3><p>约束的创建的两种方式：</p>
<ul>
<li>表建立时就进行约束定义</li>
<li>利用ALTER TABLE命令来进行创建约束</li>
</ul>
<h3 id="触发器约束"><a href="#触发器约束" class="headerlink" title="触发器约束"></a>触发器约束</h3><p>触发器的作用就是在执行insert、update、delete命令之后或之前自动调用SQL命令或存储过程。</p>
<h3 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h3><p>MyISAM存储引擎本身并不支持外键，对于外键的定义只是起到一个注释的作用。而InnoDB存储引擎则完整支持外键约束。</p>
<p>一般来说，被引用的表为父表，引用的表称为子表。外键定义时的ON DELETE和ON UPDATE表示在对父表进行DELETE和UPDATE操作时，对子表所做的操作。</p>
<p>有以下几种可定义的子表操作：</p>
<ul>
<li><p>CASCADE：父表发生delete、update时，对相应的子表中的数据也进行delete、update操作。</p>
</li>
<li><p>SET NULL：父表发生delete、update操作时，相应的子表中的数据被更新为NULL值，但是子表中相对应的列必须允许为NULL值。</p>
</li>
<li>NO ACTION表示当父表发生DELETE或UPDATE操作时，抛出错误，不允许这类操作发生。</li>
<li>RESTRICT表示当父表发生DELETE或UPDATE操作时，抛出错误，不允许这类操作发生。</li>
</ul>
<h2 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h2><p>分区功能不是在存储引擎层完成的，因此不是只有InnoDB存储引擎支持分区，常见的存储引擎MyISAM、NDB等都支持。但也并不是所有的存储引擎都支持。</p>
<p>分区的过程是将一个表或索引分解为多个更小、更可管理的部分。就访问数据库的应用而言，从逻辑上讲只有一个表或一个索引，但是物理上这个表或索引可能由数十个物理分区组成。每个分区都是独立的对象，可以独自处理，也可以作为一个更大的对象进行处理。</p>
<p>MySQL数据库支持的分区为水平分区，并不支持垂直分区。此外，MySQL数据库的分区是局部分区索引，一个分区中既有数据又有索引。</p>
<p>MySQL支持以下几种类型的分区：</p>
<ul>
<li>RANGE分区：行数据基于属于给定连续区间的列值被放入分区。</li>
<li>LIST分区：和RANGE分区差不多，只不过面向的是离散的值。</li>
<li>HASH分区：根据用户定义的表达式的返回值来进行分区，返回值不能为负数。</li>
<li>KEY分区：根据MySQL数据库提供的哈希函数来进行分区。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/01/%E5%AE%A2%E6%88%B7%E7%AB%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="乡村程序员">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码码更健康">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/01/%E5%AE%A2%E6%88%B7%E7%AB%AF/" class="post-title-link" itemprop="url">客户端</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-01 23:09:00" itemprop="dateCreated datePublished" datetime="2021-05-01T23:09:00+08:00">2021-05-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-22 21:36:34" itemprop="dateModified" datetime="2021-05-22T21:36:34+08:00">2021-05-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/" itemprop="url" rel="index"><span itemprop="name">单机数据库的实现</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文是《Redis设计与实现》中关于客户端的内容的笔记。<br>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/05/01/%E5%AE%A2%E6%88%B7%E7%AB%AF/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/01/%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="乡村程序员">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码码更健康">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/01/%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="post-title-link" itemprop="url">服务器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-01 21:11:00" itemprop="dateCreated datePublished" datetime="2021-05-01T21:11:00+08:00">2021-05-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-22 21:36:34" itemprop="dateModified" datetime="2021-05-22T21:36:34+08:00">2021-05-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/" itemprop="url" rel="index"><span itemprop="name">单机数据库的实现</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文是《Redis设计与实现》中关于服务器的内容的笔记。<br>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/05/01/%E6%9C%8D%E5%8A%A1%E5%99%A8/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/30/%E4%BA%8B%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="乡村程序员">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码码更健康">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/30/%E4%BA%8B%E5%8A%A1/" class="post-title-link" itemprop="url">事务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-30 00:00:00" itemprop="dateCreated datePublished" datetime="2021-04-30T00:00:00+08:00">2021-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-05 00:35:45" itemprop="dateModified" datetime="2021-05-05T00:35:45+08:00">2021-05-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/" itemprop="url" rel="index"><span itemprop="name">单机数据库的实现</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h1><p>Redis服务器需要处理以下两类事件：</p>
<ul>
<li>文件事件：Redis服务器通过套接字与客户端进行连接，而文件事件就是服务器对套接字操作的抽象。服务器与客户端的通信会产生相应的文件事件，而服务器则通过监听并处理这些事件来完成一系列网络通信操作。</li>
<li>时间事件：Redis服务器中的一些操作需要在给定的时间点执行，而时间事件就是服务器对这类定时操作的抽象。</li>
</ul>
<h2 id="文件事件"><a href="#文件事件" class="headerlink" title="文件事件"></a>文件事件</h2><p>Redis基于Reactor模式开发了自己的网络事件处理器：这个处理器被称为文件事件处理器：</p>
<ul>
<li>文件事件处理器使用I/O多路复用程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器。</li>
<li>当被监听的套接字准备执行连接应答、读取、写入、关闭等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件。</li>
</ul>
<h3 id="文件事件处理器的构成"><a href="#文件事件处理器的构成" class="headerlink" title="文件事件处理器的构成"></a>文件事件处理器的构成</h3><p>下图展示了文件事件处理器的构成，它们分别是套接字、I/O多路复用程序、文件事件分派器，以及事件处理程序。</p>
<p><img src="../images/%E4%BA%8B%E5%8A%A1/image-20210430000136863.png" alt="image-20210430000136863"></p>
<p>I/O多路复用负责监听多个套接字，并向文件事件分派器传送那些产生了事件的套接字。</p>
<h3 id="I-O多路复用程序的实现"><a href="#I-O多路复用程序的实现" class="headerlink" title="I/O多路复用程序的实现"></a>I/O多路复用程序的实现</h3><p>Redis的多路复用程序所有功能都是通过包装常见的select、epoll、evport和kqueue这些I/O多路复用函数库来实现的。每个I/O多路复用函数库在Redis源码中都对应一个单独的文件，比如ae_select.c、ae_epoll.c、ae_kqueue.c，诸如此类。</p>
<h3 id="事件类型"><a href="#事件类型" class="headerlink" title="事件类型"></a>事件类型</h3><p>I/O多路复用程序可以监听多个套接字的<strong>ae.h/AE_READABLE事件和ae.h/AE_WRITABLE事件</strong></p>
<p>I/O多路复用程序运行服务器同时监听套接字的读事件和写事件，如果一个套接字同时产生这两种事件，那么文件事件分派器会优先处理AE_READABLE事件。等AE_READABLE事件处理完才处理AE_WRITABLE事件。</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>ae.c中提供了这样几个api：</p>
<p>aeCreateFileEvent（将给定套接字的给定事件加入到I/O多路复用的监听范围之内）。</p>
<p>aeDeleteFileEvent（取消对给定给定套接字给定事件的监听，并取消事件和事件处理器之间的关联）。</p>
<p>aeGetFileEvents（返回给定套接字被监听的事件）。</p>
<p>aeWait（给定定时间内阻塞并等待套接字的给定类型事件的产生，产生或者超时函数返回）。</p>
<p>aeApiPoll（阻塞指定时间直到至少一个事件产生）。</p>
<p>aeProcessEvents（这是文件事件分派器，先调用aeApiPoll函数来等待事件产生，然后遍历所有已产生事件，并且调用相关的事件处理函数）。</p>
<p>aeGetApiName（返回I/O多路复用程序底层所使用的I/O多路复用函数库的名称，比如返回“epoll”、“select”）。</p>
<h3 id="文件事件的处理器"><a href="#文件事件的处理器" class="headerlink" title="文件事件的处理器"></a>文件事件的处理器</h3><p>连接应答处理器、命令请求处理器、命令回复处理器、复制处理器。</p>
<h3 id="时间事件"><a href="#时间事件" class="headerlink" title="时间事件"></a>时间事件</h3><p>Redis的时间事件分为定时事件和周期性事件。一个时间事件主要由三个属性组成：id（全局唯一标识）、when（毫秒精度UNIX时间戳）、timeProc（时间事件处理器）。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>服务器将所有时间事件都放在一个无序链表中，每当时间事件执行器运行时，它就遍历整个链表，查找所有已到达的时间事件，并调用相应的事件处理器。</p>
<h3 id="时间事件应用实例：serverCron函数"><a href="#时间事件应用实例：serverCron函数" class="headerlink" title="时间事件应用实例：serverCron函数"></a>时间事件应用实例：serverCron函数</h3><p>持续运行的Redis服务器需要定期对自身的资源和状态进行检查和调整，从而确保服务可以长期、稳定地运行，这些定期操作由redis.c/serverCron函数负责执行，它的主要工作包括：</p>
<ul>
<li>更新服务器的各类统计信息，比如时间、内存占用、数据库占用情况等。</li>
<li>清理数据库中的过期键值对。</li>
<li>关闭和清理连接失效的客户端。</li>
<li>尝试进行AOF或RDB持久化操作。</li>
<li>如果服务器是主服务器，那么对从服务器进行定期同步。</li>
<li>如果处于集群模式，对集群进行定期同步和连接测试。</li>
</ul>
<h2 id="事件的调度与执行"><a href="#事件的调度与执行" class="headerlink" title="事件的调度与执行"></a>事件的调度与执行</h2><p>因为服务器中同时存在文件事件和时间事件两种事件类型，所以服务器必须对这两种事件进行调度，决定何时应该处理这些文件事件，何时又该处理时间事件。事件的调度是由ae.c/aeProcessEvents函数负责的。</p>
<h2 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h2><ul>
<li>Redis服务器是一个事件驱动程序，服务器处理的事件分为时间事件和文件事件两类。</li>
<li>文件事件处理器是基于Reactor模式实现的网络通信程序。</li>
<li>文件事件是对套接字操作的抽象：每次套接字变为可应答（acceptable）、可写（writable）或者可读（readable）时，相应的文件事件就会产生。</li>
<li>文件事件分为AE_READABLE事件和AE_WRITABLE事件两类。</li>
<li>时间事件分为定时事件和周期性事件：定时事件只在指定的时间到达一次，而周期性事件每隔一段时间到达一次。</li>
<li>服务器在一般情况下只执行serverCron函数一个时间事件，并且这个事件是周期性事件。</li>
<li>文件事件和时间事件之间是合作关系，服务器会轮流处理这两种事件，并且处理事件的过程中也不会进行抢占。</li>
<li>时间事件的实际处理时间通常会比设定的时间晚一些。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/29/AOF%E6%8C%81%E4%B9%85%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="乡村程序员">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码码更健康">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/29/AOF%E6%8C%81%E4%B9%85%E5%8C%96/" class="post-title-link" itemprop="url">AOF持久化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-29 23:59:00" itemprop="dateCreated datePublished" datetime="2021-04-29T23:59:00+08:00">2021-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-22 21:36:34" itemprop="dateModified" datetime="2021-05-22T21:36:34+08:00">2021-05-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/" itemprop="url" rel="index"><span itemprop="name">单机数据库的实现</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文是《Redis设计与实现》中关于AOF持久化的内容的笔记。<br>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/04/29/AOF%E6%8C%81%E4%B9%85%E5%8C%96/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/27/RDB%E6%8C%81%E4%B9%85%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="乡村程序员">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码码更健康">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/27/RDB%E6%8C%81%E4%B9%85%E5%8C%96/" class="post-title-link" itemprop="url">RDB持久化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-27 22:24:00" itemprop="dateCreated datePublished" datetime="2021-04-27T22:24:00+08:00">2021-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-22 21:36:34" itemprop="dateModified" datetime="2021-05-22T21:36:34+08:00">2021-05-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/%E5%8D%95%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0/" itemprop="url" rel="index"><span itemprop="name">单机数据库的实现</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文是《Redis设计与实现》中关于RDB持久化的内容的笔记。<br>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/04/27/RDB%E6%8C%81%E4%B9%85%E5%8C%96/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="乡村程序员"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">乡村程序员</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">127</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wujiah251" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wujiah251" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/wujiahao.mail@gmail.com" title="E-Mail → wujiahao.mail@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">乡村程序员</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='45,45,200' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/canvas_lines.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
