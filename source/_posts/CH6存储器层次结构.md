title: CH6存储器层次结构
author: Jiahao Wu
categories:
  - 深入理解计算机系统
tags:
  - CSAPP
date: 2021-01-14 15:37:00
---
# **存储器层次结构**

## **存储技术**

### **随机访问存储器（Random-Access Memory,RAM）**

分为静态和动态两类（SRAM、DRAM）。SRAM比DRAM更快但更贵。  
1. SRAM：用作高速缓存存储器  
2. DRAM：用于主存及图形系统的帧缓存区  
内存系统必须周期性地通过读出，然后重写来刷新内存的每一位。有些系统会使用纠错码。  
3. 传统的DRAM
每个DRAM芯片被连接到某个称为内存控制器的电路，这个电路用来传送$\omega$位到每个DRAM芯片或者一次从每个DRAM芯片传出$\omega$位。  
4. 内存模块  
DRAM芯片封装在内存模块中，可以多个DRAM芯片同时读取和写入一个字节（举例8个DRAM芯片），合并后即为一个64位字，然后返回给内存控制器。  
5. 增强的DRAM  
- 快页模式DRAM（Fast Page Model DRAM,FPM DRAM）
- 扩展数据输出DRAM（Extended Data Out DRAM，EDO DRAM）
- 同步DRAM（Synchronous DRAM，SDRAM）
- 双倍数据速率同步DRAM（Double Data-Rate Synchronous）
- 视频RAM（Video RAM，VRAM）
6. 非易失性存储器（nonvolatile memory）  
DRAM和SRAM在断电的情况都会丧失它们的信息。只读存储器（read-only Memory）中有的类型可以读也可以写，但整齐称为ROM。  
PROM(Programmable ROM，可编程ROM)只能被编程一次，还有很多。。。  
还有可擦写可编程ROM(Erasable Programmable ROM，EPROM)、闪存(flash memory)。存储在ROM设备中的程序通常被称为固件（firmware）。
7. 访问主存  
总线(bus)，数据流通过总线在处理器和DRAM主存之间来来回回。

### **磁盘存储**  

1. 磁盘构造  
主轴、盘片、磁道、扇区、柱面等概念。
2. 磁盘容量
3. 磁盘操作  
- 寻道时间
- 旋转时间
- 传送时间
4. 逻辑磁盘块  
为了对操作系统隐藏磁盘的复杂性，现代磁盘将为它们的构造呈现一个简单的视图，一个B个扇区大小的逻辑块的序列。磁盘块封装中有一个效得硬件/固件设备，称为磁盘控制器，维护着逻辑块号和实际（物理）磁盘山去之间的映射关系。
5. 连接I/O设备    
慢于系统总线和内存总线。
6. 访问磁盘  
I/O端口、直接内存访问（Direct Memory Access，DMA）、DMA传送（DMA transfer）

### **固态硬盘（Solid State Disk，SSD）**

这是一种基于闪存的存储技术。

## **局部性**

通常表现为时间局部性（在一个具有良好的时间局部性程序中，被引用过一次的内存位置很可能在不远的将来再被多次引用）和空间局部性（在一个具有良好空间局部性的程序中，如果一个内存位置被引用了一次，那么程序很可能在不远的将来引用附件的一个内存位置）。

## **存储器层次结构（memery hierarchy）**

0. 寄存器（CPU寄存器保存着从高速缓存存储器去除的字）  
1. L1高速缓存（SRAM）（L1<-L2，保存取出的缓存行）  
2. L2高速缓存（SRAM）（L2<-L3，保存取出的缓存行）  
3. L3高速缓存（SRAM）（L3<-主存，保存取出的缓存行）  
4. 主存（DRAM）（主存<-本地磁盘，保存着取出的磁盘块）  
5. 本地二级存储（本地磁盘）（保存从远程网络服务器取出的文件）  
6. 远程二级存储（分布式文件系统、Web服务器）  

### **存储器层次结构中的缓存**

高速缓存（cache）是一个小而快的存储设备，它作为存储在更大、也更慢的设备中的数据对象的缓冲区域。使用高速缓存的过程称为**缓存（caching）**。  
1. 缓存命中：当程序需要第$k+1$层的一个数据对象d时，优先在第$k$层查找d，如果d刚好存储在第$k$层，那么直接读取，这就是我们说的缓存命中。  
2. 缓存不命中：如果第$k$层没有缓存数据对象d，那么就是我们说的缓存不命中。当发生缓存不命中时，第$k$层的缓存从第k+1层缓存取出包含d的那个块，如果第k层缓存已经满了，可能就会覆盖现存的一个块（牺牲块）。  
3. 缓存不命中的种类：强制性不命中、冲突不命中、容量不命中。  
4. 缓存管理：编译器管理寄存器文件；L1、L2和L3层的缓存完全有内置在缓存中的硬件逻辑来管理；在一个有虚拟内存的系统中，DRAM主存作为存储在磁盘上的数据块的缓存，是由操作系统软件和CPU上的地址翻译硬件共同管理的。  

### **存储器层次结构概念小结**

概括来说，基于缓存的存储器层次结构行之有效，是因为较慢的存储设备比较快的存储设备更便宜，还因为程序倾向于展示局部性（可以补偿不命中的代价）

## **高速缓存存储器**

原来存储器层次结构只有三层：寄存器、主存、磁盘；随着CPU和主存之间逐渐增大的差距，系统设
计者被迫在CPU寄存器文件和主存之间插入了一个小的SRAM高速缓存存储器，称为L1高速缓存，后来又插入了L2、L3。

### **通用的高速缓存存储器组织结构**

高速缓存的结构可以用元组（S，E，B，m）来描述。S：$S=2^s$个高速缓存组；E：每个组包含E个高速缓存行；B：每个行由$B=2^b$字节的数据块组成的，一个有效位指明这个行是否包含有意义的信息，还有t个标记位来唯一的标识这个块。$t+s+b=m$，t位标记块，s位组索引，b位时块偏移。容量$C=S\times E\times B$。

### **直接映射高速缓存**

每个组只有一行  
1. 直接映射高速缓存中的组选择  
2. 直接映射高速缓存中的行匹配  
3. 直接映射高速缓存中的字选择  
4. 直接映射高速缓存不命中时的行替换  
5. 综合：运行中的直接映射高速缓存  

### **组相联高速缓存**

1. 组相联高速缓存中的组选择  
2. 组相联高速缓存中的行匹配和字选择：搜索组中的每一行来匹配标记，命中后块偏移从这个块中选择字  
3. 组相联高速缓存中的不命中的行替换：若无空行，则采用替换策略，有LFU（Least-Frequently-Used，最不常使用）、LRU（Least-Recently-USed，最近最少使用）等。  

### **全相联高速缓存**

$E=C/B$，S=1，仅有一个组。
1. 组选择  
2. 行匹配和字选择  
因为高速缓存电路必须并行地搜索许多相匹配的标记，构造一个又大又快的相联高速缓存很困难，而且昂贵。因此全相联高速缓存只适合做小的高速缓存，例如虚拟内存系统中翻译备用缓冲器（TLB），它缓存页表项。

### **有关写的问题**

如果命中，更新了副本之后，如何更新在低一层中的副本。  
- 直写：最简单的方法，立即写回到下一级。  
- 写回：等待替换算法要驱逐这个更新过的块的时候，才把它紧接着写到低一层（需要在每个高速缓存行中额外保留一个修改位来标识该行是否被修改过）。  
如果不命中：  
- 写分配：加载相应的低一层中的块到高速缓存行中，然后更新这个高速缓存块  
- 非写分配：避开高速缓存，直接写到低一层