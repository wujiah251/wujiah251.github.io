title: TCP协议
author: Jiahao Wu
tags: []
categories:
  - 计算机网络
date: 2021-02-13 11:03:00
---
TCP是可靠传输协议，提供了可靠传输、拥塞控制等服务，接下来我们介绍TCP如何实现这些服务。  

# 序列号、确认应答、超时重传

数据到达接收方后，接收方需要发出一个确认应答，表示已经收到数据号，并且序号指出了下一个需要传入的数据段。如果接收方迟迟没有收到应答，可能是发送的数据丢失，也可能是应答丢失。这时发送方会等待一段时间，然后会进行重传。  

# 窗口控制和高速重发控制/快速重传（重复确认应答）

TCP会利用窗口控制来提高传输速度，意思是在一个窗口大小内，不用一定要等到应答才能发送下一段数据，窗口大小就是无需等待确认而可以继续发送数据的最大值。如果不使用窗口控制，每一个没收到确认应答的数据都要重发。  
使用窗口控制，如果数据段1001-2000丢失，后面数据每次传输，确认应答都会不停地发送序号为1001的应答，表示我要接收1001开始的数据，发送端如果收到3次相同应答，就会立刻进行重发；但还有种情况有可能是数据都收到了，但是有的应答丢失了，这种情况不会进行重发，因为发送端知道，如果是数据段丢失，接收端不会放过它的，会疯狂向它提醒。  

# 拥塞控制

如果把窗口定的很大，发送端连续发送大量的数据，可能会造成网络的拥堵（大家都在用网，你在这狂发，吞吐量就那么大，当然会堵），甚至造成网络的瘫痪。所以TCP在为了防止这种情况而进行了拥塞控制。  

## 慢启动

定义拥塞窗口，一开始将该窗口大小设为1，之后每次收到确认应答（经过一个rtt），将拥塞窗口大小*2。

## 拥塞避免

设置慢启动阈值，一般开始都设为65536。拥塞避免是指当拥塞窗口大小达到这个阈值，拥塞窗口的值不再指数上升，而是加法增加（每次确认应答/每个rtt，拥塞窗口大小+1），以此来避免拥塞。

将报文段的超时重传看做拥塞，则一旦发生超时重传，我们需要先将阈值设为当前窗口大小的一半，并且将窗口大小设为初值1，然后重新进入慢启动过程。

## 快速重传

在遇到3次重复确认应答（高速重发控制）时，代表收到了3个报文段，但是这之前的1个段丢失了，便对它进行立即重传。

然后，先将阈值设为当前窗口大小的一半，然后将拥塞窗口大小设为慢启动阈值+3的大小。

这样可以达到：在TCP通信时，网络吞吐量呈现逐渐的上升，并且随着拥堵来降低吞吐量，再进入慢慢上升的过程，网络不会轻易的发生瘫痪。  

## TCP协议和UDP协议比较

1. TCP是面向连接的协议，UDP是面向报文的协议，不进行连接；  
2. TCP是一对一的，UDP支持单播，多播，广播；  
3. TCP比UDP可靠，TCP提供了超时重传、拥塞控制等服务，UDP只提供发送报文的功能，并且不保证发送到；  
4. UDP的开销比TCP小，UDP头部需要存储的信息较少；  
5. UDP由于美誉拥塞控制，所以UDP流量在网络中比TCP流量更危险，举个例子：UDP流量较大，导致网络阻塞，而TCP拥塞控制算法减小了TCP流量，UDP流量占比进一步提高，最后可能整个网络都是TCP流量；
6. 对于文件等流量更适合TCP协议，而视频、音频等实时性要求高，准确性要求相对低的流量可能适合UDP协议。  
7. TCP是全双工的，UDP是单向的。



### TCP协议和UDP协议应用场景


<table>
  <tr>
    <th></th>
    <th>TCP</th>
    <th>UDP</th>
  </tr>
  <tr>
    <td>可靠性</td>
    <td>可靠</td>
    <td>不可靠</td>
  </tr>
  <tr>
    <td>思想</td>
    <td>面向字节流</td>
    <td>面向报文</td>
  </tr>
  <tr>
    <td>拥塞控制</td>
    <td>慢启动、快速恢复、拥塞避免</td>
    <td>不提供拥塞控制</td>
  </tr>
  <tr>
    <td>双工性</td>
    <td>全双工</td>
    <td>一对一、多对一、一对多、多对多</td>
  </tr>
  <tr>
    <td>效率</td>
    <td>传输效率低</td>
    <td>传输效率高</td>
  </tr>
  <tr>
    <td>应用场景</td>
    <td>准确率要求高，效率要求低</td>
    <td>效率要求高，准确率要求低</td>
  </tr>
  
  
</table>