title: 分布式数据库
author: 乡村程序员
tags:
  - 分布式系统
categories: []
date: 2021-05-31 08:20:00
---
# 分布式数据库

## 数据库中间层

为了扩展关系型数据库，最简单也是最为常见的做法就是应用层按照规则将数据拆分为多个分片，分布到多个数据库节点，并引入一个中间层来对应用屏蔽后端的数据库拆分细节。

### 架构

以MySQL Sharding架构为例，分为几个部分：中间层dbproxy集群、数据库组、元数据服务器、常驻进程。

（1）MySQL客户端库

应用程序通过MySQL原生的客户端与系统交互，支持JDBC，原有的单机访问数据库程序可以无缝迁移。

（2）中间层dbproxy

中间层解析客户端SQL请求并转发到后端的数据库。具体来讲，它解析MySQL协议，执行SQL路由，SQL过滤，读写分离，结果归并，排序以及分组，等等。中间层由多个无状态的dbproxy进程组成，不存在单点的情况。还可以再客户端和dbproxy之间引入LVS（Linux Virtual Server）进行负载均衡。不过这会造成请求需要增加一层通信开销，常见做法是直接再客户端配置中间层服务器列表。由客户端处理请求负载均衡以及中间层服务器故障等情况。

（3）数据库组dbgroup

每个dbgroup由N台数据库机器组成，其中一台为主机（Master），另外N-1台为备机（Slave）。

主机负责所有写事务及强一致事务，并将操作以binlog的形式复制到备机，备机可以支持有一定延迟的读事务。

（4）元数据服务器

元数据服务器主要负责维护dbgroup拆分规则并用于dbgroup选主。dbproxy通过元数据服务器获取拆分规则从而确定SQL语句的执行计划。另外，如果dbgroup的主机出现故障，需要通过元数据服务器选主。元数据服务器本身也需要多个副本实现HA，一种常见方式是采用Zookeeper实现。

（5）常驻进程agents

部署再每台数据库服务器上的常驻进程，用于实现监控、单点切换、安装、卸载程序等。

### 扩容

MySQL Sharding集群一般按照用户id进行哈希分区，这存在两个问题：

1. 集群容量不够怎么办？
2. 单个用户数据量太大怎么办？

对于第一个问题，MySQL Sharding集群往往会采用双倍扩容的方案，即从2台服务器扩到4台，再扩到8台，依次类推。

扩容的基本策略：

先进行主备同步，然后暂停写服务等待主备完全同步，接触主备关系，然后修改中间层的映射关系，让一部分数据映射到之前备机（现在已经不是了），然后给当前的机器分配一台备机。

第二个问题可以通过再应用层定期统计大用户，并且将这些用户的数据按照数据量拆分到多个dbgroup。

### 讨论

引用数据库中间层将后端分库分表对应用透明化，在大型互联网公司内部很常见。这种做法实现简单，对应用友好，但也有一些问题：

- 数据库复制：MySQL主备之间只支持异步复制，而且主库压力较大时可能产生很大的延迟，因此，主备切换可能会丢失最后一部分更新事务，这时往往需要人工介入。
- 扩容问题：如果系统压力过大需要增加新得机器，这个过程涉及数据重新划分，整个过程比较复杂，且容易出错。
- 动态数据迁移问题：如果某个数据库组压力过大，需要将其中部分数据迁移出去，迁移过程需要总控节点整体协调，以及数据库节点得配合。

## GoogleSpanner

Spanner的扩展性达到了全球级，可以扩展数百个数据中心，数百万台机器，上万亿行记录。更重要的是，它还能通过同步复制和多版本控制来满足外部一致性，支持数据中心事务。

### 数据模型

Spanner的表是层次化的，最底层的表是目录表。

### 架构

Spanner是全球性的，因此它有两个其他分布式存储系统没有的概念：

- Universe。一个Spanner部署的实例称为一个Universe。目前全世界有3个，一个开发、一个测试、一个线上。
- Zones。每个Zone属于一个数据中心，而一个数据中心可能有多个Zone。一般来说mZone内部的网络通信代价较低，而Zone和Zone之间的通信代价很高。

组件：

- Universe Masters：监控这个Universe里的Zone级别的状态信息。
- Placement Driver：提供了跨Zone数据迁移功能。
- Location Proxy：提供了获取数据的位置信息服务。客户端需要通过它才能够知道数据由哪台Spanserver服务。
- Spanserver：提供存储服务，功能上相当于BigTable系统中的Tablet Server。

发送读写请求时候，首先查找目录所在Spanserver，接着从Spanserver读写数据。

### 复制与一致性

每个数据中心运行着一套Colossus，每个机器由有100~1000个子表，每个子表会在多个数据中心部署多个副本。为了同步系统中的操作日志，每个子表上会运行一个Paxos状态机。Paxos协议会选出一个副本作为主副本，这个主副本的寿命默认是10s，正常情况下，这个主副本会在快要到期的时候将自己再次选为主副本。

通过Paxos协议，实现了跨数据中心的多个副本之间的一致性。另外，每个主副本所在Spanserver还会实现一个锁表用于并发控制，读写事务操作某个子表上的目录时需要通过缩表避免多个事务之间的互相干扰。

除了锁表，每个主副本上还有一个事务管理器。如果事务在一个Paxos组里面，可以绕过事务管理器。但是一旦事务跨多个Paxos组，就需要事务管理器来协调。

锁表实现单个Paxos组内的单机事务，事务管理器实现跨多个Paxos组的分布式事务。为了实现分布式事务，需要2PC，有一个Paxos组的主副本会成为协调者。

### True Time

数据库需要给每个事务分配全局唯一的事务id。然而，在分布式系统中，很难生成全局唯一id。Spanner通过全球时钟同步机制Tru

eTime。



















