title: 分布式系统
tags: []
categories:
  - 分布式系统
author: 乡村程序员
date: 2021-05-27 23:17:00
---
# 分布式系统



## GFS（Google File System）

### 系统架构

GFS的节点可以分为三种：GFS Master（主控服务器）、GFS ChunkServer（CS，数据块服务器）以及GFS客户端。

客户端是GFS提供给应用程序的访问接口，客户端访问GFS的时候，首先访问主控服务器节点，获取与之进行交互的CS信息，然后直接访问这些CS，完成数据交互工作。

### Master设计

Master维护了系统中的元数据，包括文件及chunk命名空间、文件到chunk之间的映射、chunk副本的位置信息。

负载均衡：

为了提高系统的可用性，GFS会避免将同一个chunk的所有副本都存放在同一个机架的情况。

三种创建chunk副本的情况：chunk创建、chunk复制以及负载均衡。

## BigTable

BigTable系统保证强一致性，同一时刻同一个子表只能被一台Tablet Server服务。这通过Chubby的互斥锁机制保证。当Tablet Server启动时候需要获取Chubby互斥锁，当Tablet Server出现故障，Master需要等到互斥锁失效，才能把它上面的子表迁移到其他Tablet Server。

BitTable的底层存储系统使用GFS。GFS本质是一个弱一致模型，只保证“同一个记录至少成功写入一次”，但可能存在一些补零记录、重复记录。



BigTable写入GFS的数据分为两种：

- 操作日志：当Tablet Server发生故障时，它上卖弄服务的子表会被集群中的其他Tablet Server加载继续提供服务。加载子表可能需要回放操作日志，每条操作日志都有唯一序号，通过它可以去除重复的操作日志。
- 每个子表的SSTable数据：如果GFS写入失败，可以重试并产生多条重复记录，但是BigTable只会索引最后一条写入成功的记录。

**BigTable本质上是构建 在GFS之上的一层分布式索引，通过它解决了GFS遗留的一致性问题**



为了提高性能，Tablet Server没有为它服务的每个子表单独存储日志，而是讲它服务的所有子表看的操作日志混在一起写入GFS，每条日志通过<表格编号，行主键，日志序列号>来唯一标识。

### 负载均衡

子表是负载均衡的基本单位。

Tablet Server定期向Master汇报状态，当状态检测时发现某个Tablet Server上的负载过重的时候，Master会自动对其进行负载均衡，即执行子表迁移工作。

- 第一步请求原有的Tablet Server卸载子表；
- 第二部选择一台负载较低的Tablet Server加载子表。

为了尽量减少停服务的时间，BigTable内部的策略是Minor Compaction。

- 对原有的子表执行一遍Minor Compaction操作，操作过程中仍然允许写操作。
- 停止子表服务，对子表再执行一边Minor Compaction操作，由于第一次Minor Compaction过程中写的数据一般比较少，所以第二次写入的数据一般比较少。

### 分裂和合并

BigTable中如果写入过多，可能出现某些子表过大，某些子表过小的情况，需要执行分裂和合并操作。

每个子表的数据分为内存中的MemTable和GFS中的多个SSTable，由于同一个子表只被一台Tablet Server服务，进行分裂比较简单，不需要进行实际的数据拷贝工作，只要将内存中的索引分成两个范围即可。

合并操作由Master发起，相比分类操作会更加复杂，由于两个子表可能被不同的Tablet Server加载，合并的第一步需要迁移其中一个子表，以使它们在同一个Tablet Server上，接着通知Tablet Server执行子表合并。

### 问题

BigTable把可扩展性做到了极致，但是也面临了一些问题：

- BigTable非常适合离线或者半线上业务，然而Tablet Server节点出现故障时，部分数据短时间内无法提供读写服务，不适合实时性要求特别高的业务，比如交易类业务。
- 架构的复杂性导致问题特别难定位：BigTable依赖GFS和Chubby，而这两者本身就非常复杂，这将导致使用的过程中很难发现问题。

## Megastore

Megastore 融合了 NoSQL 的扩展性(scalability)和 RDBMS 的便利性(convenience)， 提供强一致性保证(strong consistency guarantees) 和高可用性(high availability)。 在数据的细粒度分区(fine-grained partitions)中提供了完全可序列化的 ACID 语义。 在广域网同步复制(synchronously replicate)每一次写操作，具有合理的延迟(reasonable latency)， 支持在数据中心间无缝故障转移(seamless failover)。

Megastore由三个部分组成：

- 客户端库，应用程序通过客户端操作Megastore的实体组。Megastore系统大部分功能集中在客户端，包括映射Megastore操作到BigTable，事务即并发控制，基于Paxos的复制。
- 复制服务器：接受客户端的用户请求并转发到所在机房的BigTable实例（解决跨机房连接数太多的问题）。
- 协调者：存储每个机房本地的实体组是否最新状态的信息，用于实现快速读。

Megastore功能主要三个部分：映射Megastore数据模型到BigTable，事务及并发控制，跨机房数据复制及读写优化。

Megastore首先解析用户通过客户端传入的SQL请求，接着根据用户定义的Megastore数据模型讲SQL请求转化为对底层BigTable的操作。

### 实体组

每个实体组内的操作日志采用Paxos的方式同步到多个机房，保证强一致性。实体组之间通过分布式队列的方式保证最终一致性或者两阶段提交协议的方式实现分布式事务。

- 单集群实体组内部：同一个实体内部支持满足ACID特性的事务。通过REDO日志的方式来实现。

- 单集群实体组之间：实体组之间一般采用分布式队列的方式提供最终一致性，子表服务器上有定时扫描线程，发送跨实体组的操作到目的实体组。如果需要保证多个实体组之间的强一致性，即分布式事务，只能通过两阶段提交协议加锁协调。

### 并发控制

三种读方式：

- 最新读取
- 快照读取
- 非一致性读取

前两种方式都是在单个实体组内部完成的，在读取之前确保所有已提交的写操作已经全部生效，然后读取最后一个版本的数据。对于快照读取，系统已知的最后一个完整数据十五版本并取出该版本的数据。这两种读取方式利用率BigTable存储多版本数据的特性，保证不会读到未提交的事务。非一致性读取忽略日志的状态而直接读取BigTable内存中最新的值。

写事务：

先将所有的操作都在日志中记录下来后，写操作才会对数据库执行修改。

大致流程：

- 读取：获取最后一次提交事务的时间戳和日志位置。
- 应用逻辑：从BigTable读取并且讲写操作聚集到日志缓冲区中；
- 提交：将缓冲区中的操作日志追加到多个机房的BigTable集群，通过Paxos的协议保证一致性；
- 生效：应用操作日志，更新BigTable中的实体和索引；
- 清理：删除不需要的数据。

### 索引

Megastore数据模型中有一个非常重要的概念：索引，分为两大类：

- 局部索引：只在单个实体组内部的，用于加速单个实体组内部的查找。局部索引属于某个实体组，实体组内部数据和局部索引的更新操作是原子里的。
- 全局索引：全局索引横跨多个实体组。

### 协调者

#### 快速读

Paxos协议要求读取最新的数据至少需要经过一半以上的副本，然而，如果不出现故障，每个副本基本都是最新的。也就是说，能够利用本地读取实现快速读，减少读取延时和跨机操作。Megastore引入协调者来记录每个本机房Bigtable实例中的每个实体组的数据是否最新。如果最新，读取操作只需要本地读取，没有跨机房操作。实体组有更新操作时，写操作需要将协调者记录的实体组状态更新为无效。如果某个机房的Bigtable集群写入失败，需要首先使得相应的协调者记录实体组状态失效以后写操作才可以成功返回客户端。

#### 协调者的可用性

每次写操作都要涉及协调者，因此协调者出现故障将会导致系统不可用。当协调者因为网络或者主机故障等原因不可用时，需要检测到协调者故障并将它隔离。

Megastore使用了Chubby锁服务，协调者在启动时从数据中心获取Chubby锁。为了处理请求，协调者必须持有Chubby锁。一旦因为出现问题导致锁失效，协调者会恢复到一个默认的保守状态：认为所有它所能看见的实体组都是失效的。然后，从协调者不可用到锁失效有一个短暂的Chubby锁过期时间，这个时间段写操作都会失败。所有的写入者都必须等待协调者的Chubby锁过期。

### 竞争条件

除了可用性问题，对于协调者的读写协议必须满足一系列的竞争条件。失效操作总是安全的，但是生效操作必须谨慎处理。在异步网络环境中，消息可能乱序达到协调者。每条生效和失效消息都带有日志位置信息。如果协调者先收到较晚的是小操作再收到较早的生效操作，生效操作将被忽略。

### 读取流程

Megastore的读取流程如图所示，Megastore最新读取流程如下：

![QQ图片20210530231200](../images/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/QQ%E5%9B%BE%E7%89%8720210530231200.jpg)

### 写入流程

![image-20210530232408623](../images/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20210530232408623.png)

### 分析

Megastore的创新点：

- 提出实体组的数据模型，通过实体组内部维持关系型数据库的ACID特性。实体组之间维持类似NoSQL的弱一致性，有效地融合了SQL和NoSQL两者的优势。
- 通过Paxos协议保证高可靠性和高可用性，即把数据强同步到多个机房，又做到发生故障时，自动切换不影响读写服务。