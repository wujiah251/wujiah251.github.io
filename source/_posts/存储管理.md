title: 存储管理
author: Jiahao Wu
categories: 操作系统
date: 2021-01-29 23:22:49
tags:
---
# 为什么要使用虚拟地址空间？

1. 程序大小的增长速度总是很快，使用虚拟地址空间可以扩大地址空间。  
2. 如果使用物理地址空间，进程之间共享物理内存，容易造成竞争和程序的崩溃，使用虚拟地址空间还可以增加程序的安全性。  
3. 使用物理地址空间，同时运行多个程序是困难的。  

# 地址空间

## 地址空间的概念

**地址空间** 是一个进程可用于寻址内存的一套地址集合。每个进程都有自己的地址空间，并且这个地址空间独立于其他进程的地址空间。

### 基址寄存器和界限寄存器

经典的重定位方法。基址寄存器存储程序的起始物理地址，界限寄存器存储程序长度。  
每次一个进程进行访问内存，取一条指令、读取或写一个数据字，CPU会把地址发送到内存总线前，自动把基址值加到进程发出的地址值之上。  
这个方法比较容易，但是由于每次访问内存都需要进行加法和比较运算，会消耗很多时间。

## 交换技术

现实中我们常常要打开多个程序，每个进程都需要占据一定的内存，如果打开程序比较多，会造成内存不足的问题，有一种简单的处理内存超载的方法，**交换（swapping）技术**。当一个进程空闲时，存放在磁盘上，所以它不运行时不占用内存。另一个方法是**虚拟内存**，虚拟内存使得程序可以只有在一部分被读入内存时运行。  

交换技术很好理解，我们讨论一下其可能面临的一些问题，我们知道很多程序设计语言都可以动态地分配内存，那么当进程空间视图增大的时候，就会出现问题：  
- 有相邻空闲区：将相邻空闲区分配给进程；  
- 没有相邻空闲区：把一个或多个进程换出，以便生成足够大的空闲区。  
如果大部分进程运行时都需要增长，为了减少换入换出的开销，我们在最开始的时候为进程额外分配一些内存，这个预留空间位于堆栈和数据段之间，他们都可以使用其。

## 空闲内存管理

### 位图

我们可以把内存划分为小到几个字达到几千字的内存单元，然后用位图来记录使用情况。  
问题：当我们需要分配占k个单位内存时，，需要在位图中匹配长度为k的0串，这是一个耗时操作。  
### 使用链表的存储管理

维护一个记录已分配内存段和空闲内存段的链表。链表一个结点或者包含一个进程，或者包含一个位于两个进程之间的空闲区。  

如果按照地址顺序来存放进程和空闲区时，有几种算法可以来为进程分配内存：  
- 首次适配算法；  
- 下次适配算法；
- 最佳适配算法；  
- 最差适配算法。  

如果单独维护空闲区链表和进程链表，可以提高以上四个算法的速度，但是释放内存将内存从进程表中删除并插入到空闲区链表的时间成本高昂。  

当然如果我们单独维护空闲区链表和进程链表，可以按照大小升序排列，这样可以提高最佳适配的效率。  

还有一种分配算法叫做**快速适配**，为空闲区维护一个单独的链表。例如，这个表的第一项指向一个大小为4KB的空闲区，第二项指向一个大小为8KB的空闲区，第三项指向一个大小为12KB的空闲区。这样子寻找一个指定大小的空闲区是非常迅速的，但是缺点是合并空闲区相当费时。  

# 虚拟内存

尽管基址寄存器和界限寄存器可以用于创建地址空间的抽象，但无法解决程序大小的膨胀问题。虚拟内存的基本思想是每个程序都拥有自己的地址空间，空间被分为多个块，每一块称作一页。  

## 分页

内存管理单元（Memory Management Unit，MMU），MMU把虚拟地址映射为物理内存地址。  

访问虚拟内存，首先查询页表项（以一级页表为例），如果页表项显示不存在（缓存为命中），则引起缺页中断，陷入内核，由内核将需要的页写入到内存中（如果内存已满，会替换掉一个不常用的页，然后将被替换页写入磁盘）；如果显示存在，从页表项索引到页所在位置；找到物理内存的页后，根据虚拟地址的偏移量来确定最终物理地址。  
注：页表项还可以添加其他信息，比如读写控制等。  

## 转换检测缓冲区（TLB）

每次内存访问都需要多次访问页表也就是多次访问内存，为了节约时间，使用一种缓存技术TLB，TLB通常在MMU中（硬件实现，所以快），包含少量的表项，每个表项记录一个页面信息，包括虚拟页号，页面的修改位、保护码和该页所对应的物理页框。在每次内存访问时，都会首先访问TLB，寻找匹配表项，如果TLB命中，则不再访问页表，如果不命中，再访问页表，然后再将这次表项读入到TLB（也会淘汰一个TLB表项），下次再访问这个页表，自然会命中了。  

# 页面置换算法

## 最优页面置换算法

选择最晚将被使用的页面被置换，这个算法很好理解，而且被证明时最优的，但是问题在于我们无法预测页面何时将再被使用。当然可以跟踪页面使用情况来预测，但是这样是不划算的。  

## 最近未使用页面置换算法

最近未使用也很好理解，而且容易实现，性能也够用。  

## 先进先出页面置换算法

还有很多其他页面置换算法，比如时钟页面置换算法，最近最少使用页面置换算法等等，不做赘述。


# 分页系统中的设计问题

## 局部分配策略和全局分配策略

局部就是指页面置换时只考虑同一进程的内存，而全局就是考虑所有进程的内存。一般来说，全局的性能更优，而且可以避免一个需要较大内存的进程只被分配了少量物理内存。  
还有一些动态的分配策略，会实时参考缺页中断率来分配内存。

## 负载控制

即使使用最优页面置换算法，系统也可能发生“抖动”，这在于每个进程都在渴求更多的内存，导致进程不断被频繁换入换出，解决方案是暂时从内存中去掉一些进程。  

### 共享页面

如果不同进程之间共享某页面，可以让他们都指向同一个页面集合，然后当读的时候并不进行页面复制，仅有写发生时进行页面复制，这称为写时复制。  

### 内存映射文件

通过一个系统调用把文件映射到虚拟地址空间的一部分。这样可以把文件当作一个大型的字符数组来访问，而且这样子可以通过共享内存来通信，一个进程在共享内存上完成了写操作，另一个进程在映射到这个文件的虚拟地址空间之上指向读操作时，它就可以立即看到上一个进程写操作了。这个机制为进程之间提供了一个高带宽通道。

# 分段

一个编译器在编译过程中会创建许多表，其中可能包括：  
1. 被保存起来供打印清单用的程序正文；  
2. 符号表，包含变量的名字和属性；  
3. 包含用到的所有整型量和浮点常量的表；  
4. 语法分析树，包含程序语法分析的结果；  
5. 编译器内部过程调用使用的堆栈。  

我们需要一个能够把程序员从管理表的扩张和收缩工作中解出来的方法，就像虚拟内存使程序员不用再为怎么样把程序划分称覆盖块担心一样。  
一个直观并且通用的方法是在机器上提供多个互相独立的称为段的地址空间。  
一个段一般不包含不通类型的内容。在分段系统中，修改一个过程不会影响其他无关的过程的起始地址。  
分段是一个逻辑实体，程序员知道这一点并把它作为一个逻辑实体来使用。  
页面的内容从某种意义上是随机的，程序员甚至察觉不到分页的事实，而分段对程序员是已知的。

## 分段和分页的结合

分段和分页可以结合起来使用，一个例子就是MULTICS。具体细节参考《现代操作系统》P134-P135。  


