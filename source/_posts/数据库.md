title: 数据库
author: 乡村程序员
tags: []
categories: Redis
date: 2021-04-27 12:53:00

---
本文是《Redis设计与实现》中关于数据库的内容的笔记。
 <!-- more -->

# 数据库

## 服务器中的数据库

Redis服务器将所有数据库都保存在服务器状态redisServer的数组中，db数组的每个项都是一个redis.h/redisDb结构，每个redisDB结构都代表一个数据库。

```c
struct redisServer{
	// ...
	// 一个数组，保存着服务器中所有的数据库
	redisDb *db;
	// ...
}
```

dbnum默认为16，由服务器配置的database选项决定。

## 切换数据库

每个Redis客户端都有自己的目标数据库当每个客户端执行数据库写命令或者数据库读写命令的时候，目标数据库就会成为这些命令的操作对象。

默认情况下，Redis客户端的目标数据库为0号数据库，但客户端可以通过执行select命令来切换目标数据库。

```shell
redis> set msg "hello world"
OK
redis> get msg
"hello world"
redis> select 2
OK
redis[2]> set msg "another world"
OK
redis[2]> get msg
"another world"
```

在服务器内部，客户端状态redisClient结构的db属性记录了客户端当前的目标数据库，这个属性是一个指向redisDb结构的指针：

```c
typedef struct redisClient{
	// ...
	redisDb *db;
	// ...
}redisClient;
```

由于redis不提供显示返回当前数据库的命令。所以建议在执行较为危险的指令的时候显示地执行一个select命令，切换到指定的数据库。

### 数据库键空间

redisDb结构中的dict字典保存了数据库中的所有键值对，我们将这个字典称为键空间：

```c
typedef struct redisDb{
	// ...
	dict *dict;
	// ...
}
```

键空间和用户所见的数据库是直接对应的：

- 键空间的键也就是数据库的键，每个键都是一个字符串对象。
- 键空间的值也就是数据库的值，每个值可以说字符串对象、列表对象、哈希表对象、集合对象和有序集合对象中的任意一种Redis对象。

### 读写键空间时的维护操作

当Redis命令对数据库进行读写时，服务器不仅会对键空间执行指定的读写操作，还会执行一些额外的维护操作，其中包括：

- 读取一个键之后会根据键是否存在来更新服务器的键空间命中次数或键空间不命中次数，这两个值可以在INFO stats命令的keyspace_hits属性和keyspace_misses属性中查看。
- 读取一个键盘之后，服务器会更新键的LRU时间（最后一次使用时间），这个值可以用于计算键的闲置时间。
- 如果服务器在读取一个键时发现该键已经过期，那么服务器会删除这个过期键，然后才执行余下的其他操作。
- 如果客户端使用watch命令监视了某个键，那么服务器在对被监视的键进行修改之后，会将这个键标记为脏（dirty），从而让事物程序注意到这个键已经被修改过。
- 服务器每次修改一个键之后，都会对脏（dirty）键计数器的值增1，这个计数器会触发服务器的持久化以及复制操作。
- 如果数据库开启了数据库通知功能，那么在对键进行修改之后，服务器按配置发送相应的数据库通知。

## 设置键的生存时间或过期时间

Redis提供了expire或者pexpire命令设置键的生存时间，当经过了指定的时间之后，服务器会自动删除生存时间为0的键。

客户端还可以通过expireat命令或者pexpireat命令，以秒或者毫秒精度给数据库中的某个键设置过期时间。

### 保存过期时间

redisDb结构的expires字典保存了数据库所有键的过期时长，我们称这个为字典的过期字典：

- 过期字典的键是一个指针，这个指针指向键空间的某个键对象。

- 过期字典的值一个是long long类型的整数，这个整数保存了键指向的数据库键的过期时间（毫秒精度的UNIX时间戳）。

## 过期键删除策略

### 定时删除

定时删除策略对内存最友好：通过使用定时器，定时删除策略可以保证过期键会尽可能快地删除，并释放过期键所占用的内存。

缺点：对CPU时间非常不友好：过期键比较多时，删除过期键可能会占用相当一部分CPU时间，在内存不紧张但是cPU时间非常紧张的情况下，将CPU时间浪费在删除和当前任务无关的过期键上，无疑会对服务器的响应时间和吞吐量造成影响。

### 惰性删除

惰性删除对CPU时间来说是最友好的：程序只会在取出键时才对键进行过期检查，这可以保证删除过期键的操作只会在非做不可的情况下进行，并且删除目标仅限于当前处理的键，不会在无关键上浪费CPU时间。

### 定期删除

从上面的分析来看，这两种删除方式在单一使用时都有明显的缺陷：

- 定时删除占用太多CPU时间，影响服务器的响应时间和吞吐量。

- 惰性删除浪费太多内存，有内存泄露的危险

定期删除是两个策略的折中：

- 每隔一段时间执行一次删除过期操作，并通过限制删除操作执行的时长和频率来减少删除操作对CPU时间的影响。
- 除此之外，通过定期删除过期键，定期删除策略有效地减少了因为过期键而带来的内存浪费。

## Redis的过期键删除策略

Redis服务器实际上使用的是惰性删除和定期删除两种策略：通过配合使用这两种删除策略，服务器可以很好地在使用CPU时间和避免浪费内存空间之间取得平衡。

## AOF、RDB和复制功能对过期键的处理

### 生成RDB文件

在执行SAVE命令或者BGSAVE命令创建一个新的RDB文件时，程序会对数据库中的键进行检查，已过期的键不会被保存到新创建的RDB文件中。

### 载入RDB文件

在启动Redis服务器时，如果服务器开启了RDB功能，那么服务器将对RDB文件进行载入。

- 如果服务器以主服务器模式运行，那么在载入RDB文件时，程序会对文件中保存的键进行检查，未过期的键会被载入到数据库中，而过期键则会被忽略，所以过期键对载入RDB文件的主服务器不会造成影响。
- 如果服务器以从服务器模式运行，那么载入RDB文件时，文件保存的所有键，无论是否过期都会被载入数据库中。

### AOF文件写入

当服务器以AOF持久化模式允许时，如果数据库中的某个键已经过期，但它还没有被惰性删除或者定期删除，那么AOF文件不会因为这个过期键而产生任何影响。

当过期键被惰性删除或者定期删除之后，程序会向AOF文件追加一条DEL命令，来显式地记录该键已被删除。

### AOF重写

和生成RDB文件时类似，在执行AOF重写的过程中，程序会对数据库中的键进行检查，已过期的键不会被保存到重写后的AOF文件中。

### 复制

当服务器运行在复制模式下时，从服务器的过期键删除动作由主服务器控制：

- 主服务器在删除一个过期键之后，会显示地向所有从服务器发送一个DEL命令，告知从服务器删除这个过期键。
- 从服务器在执行客户端发送的读命令时，即使碰到过期键也不会将过期键删除，而是继续像处理未过期的键一样来处理过期键。
- 从服务器只有在接到主服务器发来的DEL命令之后，才会删除过期键。

## 数据库通知

数据库通知是Redis2.8版本新增的功能，这个功能可以让客户端通过订阅给定的平道或者模式，来获知数据库中键的变化，以及数据库命令的执行情况。

服务器配置的notify-keyspace-events选项决定了服务器所发送通知的类型。

## 重点回顾

- Redis服务器的所有数据库都保存在redisServer.db数组中，而数据库的数量则由redisServer.dbnum属性保存。
- 客户端通过修改目标数据库的指针，让它指向redisServer.db数组中的不同元素来切换不同的数据库。
- 数据库主要由dict和expires两个字典构成，其中dict字典负责保存键值对，而expires字典则负责保存键的过期时间。
- 因为数据库由字典构成，所以对数据库的操作都是建立在字典操作之上的。
- 数据库的键总是一个字符串对象，而值则可以是任意一种Redis对象类型，包括字符串对象、哈希表对象、集合对象等等。
- expires字典的键指向数据库中的某个键，而值则记录了数据库键的过期时间，过期时间是一个以毫秒为单位的UNIX时间戳。

- Redis使用惰性删除和定期删除两种策略来删除过期的键。
- 执行SAVE命令或者BGSAVE命令所产生的新RDB文件不会包含已经过期的键。
- 执行BGREWRITEAOF命令所产生的重写AOF文件不会抱憾已经过期的键。
- 当一个过期键被删除之后，服务器会追加一条DEL命令到现有的AOF文件的末尾，显示地删除过期键。
- 当主服务器删除一个过期键之后，它会向所有服务器发送一条DEL命令，显示地删除过期键。
- 从服务器即使发现过期键也不会自作主张地删除它，而是等待主节点发来DEL命令，这种统一、中心化的过期键删除策略可以保证主从服务器数据的一致性。
- 当Redis命令对数据库进行修改之后，服务器会根据配置向客户端发送数据库通知。