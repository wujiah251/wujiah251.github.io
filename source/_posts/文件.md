---
title: 文件
date: 2021-05-10 23:05:56
tags:
---

# 文件

几种类型：

- 参数文件
- 日志文件
- socket文件
- pid文件
- MySQL表结构文件
- 存储引擎文件

## 日志文件

常见日志文件：

- 错误日志（error log）
- 二进制日志（binlog）
- 慢查询日志（slow query log）
- 查询日志（log）

### 错误日志

错误日志记录了MySQL的启动、运行、关闭过程中的错误信息，甚至包含一些警告和正确信息，一旦出现问题，我们最先应该查看的就是这个文件。

### 慢查询日志

慢查询日志可以帮助DBA定位可能存在问题的SQL语句，从而进行SQL语句层面的优化。例如，可以在MySQL启动时设置一个阈值，将运行时间超过该值的所有SQL语句都记录到慢查询日志中。然后定期检查慢查询日志，确认是否有SQL语句需要优化。

## 套接字文件

在UNIX系统下本地连接mysql可以采用unix域套接字方式。这种方式需要一个套接字文件。套接字文件可由参数socket控制。一般在/tmp目录下，名为mysql.sock。

## pid文件

当MySQL实例启动时，会将自己的进程ID写入一个文件中——该文件即为pid文件。

## 表结构定义文件

frm为后缀名的文件，这个文件记录了该表的表结构定义。frm文件还用来记录视图的定义。

## InnoDB存储引擎文件

### 表空间文件

InnoDB采用将存储的数据按表空间进行存放的设计。在默认配置下会有一个初始大小的10MB，名为idbata1的文件，该文件是默认的表空间文件。用户可以通过多个文件组成也给表空间。若这些文件属于不同的磁盘，磁盘的负载可能被平均，因此可以提高数据库的整体性能。

所有基于InnoDB存储引擎的表的数据都会记录到该共享表空间中。若设置了参数innodb_file_per_table，则用户可以将每个基于InnoDB存储引擎的表产生一个独立的表空间。

独立表空间的命名规则为：表名.ibd。通过这样的方式，用户不用将所有数据存放于默认的表空间中。

要注意的是：单独的表空间文件仅存储该表的数据、索引和插入缓冲BITMAP等信息，其余信息还是存放在默认表空间中。

### 重做日志文件

当实例或者介质失败时，重做日志就能派上用场。例如，数据库由于所在主机掉电导致实例失败，InnoDB存储引擎会使用重做日志恢复到掉电前的时刻。

每个InnoDB存储引擎至少有一个重做日志文件组，每个文件组下至少有2个重做日志文件。为了得到更高的可靠性，用户可以设置多个镜像日志组，将不同的文件组放在不同的磁盘上，以此提高重做日志的高可用性。

每个日志组的每个重做日志文件的大小一致，并以循环写入的方式运行。InnoDB存储引擎先写重做日志文件1，当到达文件的最后，再切换到重做日志文件2，依此类推。

重做文件日志不能太小，否则会导致频繁地发生async checkpoint，导致性能的抖动。

和二进制日志的区别：

binlog会记录所有与MySQL有关的日志记录，而InnoDb存储引擎只记录有关该存储引擎本身的事务日志。

二进制日志仅在事务提交前进行提交，即只写磁盘一次。

不论事务有多大，在事务进行过程中，却不断有重做日志条目被写入到重做日志文件中。

重做日志条目结构：

|redo_log_type|space|page_no|redo_log_body

- redo_log_type占用一个字节，表示重做日志的类型。

- space表示表空间的ID，但采用压缩的方式，因此占用的空间可能小于4字节。
- page_no表示页的偏移量，同样采用压缩的方式。
- redo_log_body表示每个重做日志的数据部分，恢复时需要调用相应的函数进行解析。

写入重做日志文件的操作不是直接写，而是先写入一个重做日志缓冲中，然后按照一定的条件顺序地写入日志文件。从重做日志缓冲往磁盘写入时，是按512字节，也就是一个扇区的大小进行写入。

从日志缓冲写入重做日志文件是按照一定条件进行的，比如主线程每秒写入一次。或者通过innodb_flush_log_at_trx_commit，如果该值设置为1，表示在执行commit时，将重做日志缓冲同步到磁盘，即伴有fsync的调用。2表示将重做日志异步写道磁盘，即写道文件系统的缓存中。















