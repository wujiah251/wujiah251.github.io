title: 简单动态字符串
author: 乡村程序员
tags: []
categories:
  - Redis
  - 数据结构与对象
date: 2021-04-19 18:33:00
---
# 简单动态字符串

## SDS的定义

sdshr这个结构体定义在redis源码``src/sds.h``里面。  
```C
struct sdshdr{
	int len;
	int free;
	char buf[];
};
```
len表示字符串长度，free表示已经分配的未使用空间，buf用来存储字符。  

## SDS与C字符串的区别

1. 常数级别获取字符串长度：由于提供了sdshdr字段。  
2. 杜绝缓冲区溢出：C风格字符串使用strcat这类的函数有缓冲区溢出的风险，但是sdshdr可以检查free来判断是否有足够的空间。  
3. 减少字符串修改时候带来的内存重写分配次数：空间预分配（每当SDS的API对一个SDS进行修改的时，并且需要对SDS进行空间扩展的时候，程序不仅会为SDS分配修改所必要的空间，还会为SDS分配额外的未使用空间）、惰性空间释放（每当SDS的API需要缩短SDS保存的字符串时，程序并不立即使用内存的重写分配来回收缩短后多出来的字节，而是使用free属性将这些字节的数量记录起来，并等待将来使用）。  
4. 二进制安全：C字符串需要空字符来标识字符串末尾，这导致了C字符串不能用来存储包含会被误认为空字符的内容的数据类型，比如图片、音频，而SDS由于提供了len信息，其实并不需要空字符来做为结尾标识，以处理二进制数据的方式来处理数据，所以称为二进制安全。  
5. 兼容部分wC字符串函数，虽然SDS是二进制安全的，但是它还是遵循了空字符串的惯例，将数据末尾保存为空字符，这使得它能够使用一部分的C字符串函数。  









