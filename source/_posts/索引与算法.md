title: 索引与算法
tags:
  - MySQL
categories:
  - MySQL学习
  - InnoDB
author: 乡村程序员
date: 2021-05-13 23:03:00
---

# 索引与算法

## InnoDB存储引擎概述

InnoDB存储引擎支持以下几种常见索引：

- B+树索引
- 全文索引
- 哈希索引

### 聚集索引

聚集索引就是按照每张表的主键构造一棵B+树，同时叶子节点中存放的即为整张表的行记录数据，也将聚集索引的叶子节点称为数据页。聚集索引的这个特性决定了索引组织表中数据也是索引的一部分。同时B+树数据结构一样，每个数据页都通过双向链表来进行链接。

每张表只能拥有一个聚集索引哦！

数据页上存放的是完整的每行的记录，而在非数据页的索引页中，存放的仅仅是键值及指向数据页的偏移量，而不是一个完整的行记录。

聚集索引的存储并不是物理上连续的，而是逻辑上连续的。这其中有两点：一是前面说过的页通过双向链表链接，页按照主键的顺序排序；另一点是每个页中的记录也是通过双向链表进行维护的，物理存储上可以同样不按照主键存储。

聚集索引的一个好处就是：对于主键的排序查找和范围查找速度非常快。叶子节点的数据就是用户要查询的数据。

### 辅助索引

对于辅助索引，叶子节点并不包含行记录的全部数据。叶子节点除了包含键值以外，每个叶子节点中的索引行中还包含了一个书签。该书签用来告诉InnoDB存储引擎哪里可以找到与索引相对应的行数据。由于InnoDb存储引擎表是索引组织表，因此InnoDB存储引擎中辅助索引与聚集索引的关系。

辅助索引的存在并不影响数据在聚集索引中的组织，因此每张表上可以有多个辅助索引。当通过辅助索引来寻找数据时，InnoDB存储引擎会遍历辅助索引并通过叶级别的指针获得指向主键索引的主键。然后再通过主键索引来找到一个完整的行记录。

聚集索引和非聚集索引的优缺点：

- 聚集索引：检索效率高，索引占用的空间少，对数据新增/修改/删除的速度影响比较大。
- 非聚集索引：不影响表中的数据存储顺序，检索效率比聚集索引低，索引占用硬盘存储空间大，对数据新增/修改/删除的影响很少。

MySQL数据库对于索引的添加或者删除的这类DDL操作，MySQL数据库的操作过程为：

- 首先创建一张新的临时表，表结构为通过命令ALTER TABLE新定义的结构。
- 然后把原表中数据导入到临时表。
- 接着删除原表。
- 最后把临时表重名为原来的表名。

这个操作会导致数据库服务暂时不可用（要修改的表）。

InnoDB存储引擎后面开始支持一种称为Fast Index Creation的索引创建方式——简称FIC。

对于辅助索引的建立，InnoDB存储引擎会对创建索引的表上加上一个S锁。在创建的过程中，不需要重建表，因此速度较之前提高了很多，并且数据结构的可用性也得到了提高。删除辅助索引操作就更简单了，InnoDB存储引擎只需要更新内部视图，并将辅助索引的空间标记为可用，同时删除MySQL数据库内部视图上对该表的索引定义即可。

由于FIC在索引的创建过程中加上了S锁，因此在创建过程中只能对该表进行读操作，若有大量的事务需要对目标表进行写操作，那么数据库的服务同样不可用。

**Online Schema Change**

OSC（在线架构改变）最早是FaceBook实现的一种在线执行DDL的方式，并广泛地应用于Facebook的MySQL数据库。所谓”在线“是指在事务的创建过程中，可以有读写事务对表进行操作，这提高了原有的MySQL数据库在DDL操作时的并发性。





